# 软件设计 

## 系统设计 

### 系统设计原则 

本研究目标为开发一款具有高实用性和易用性的图形泛基因组浏览器，因而在原型设计和技术选型时以性能、交互性、便捷性、可获得性、稳定性等为优先。 

### 系统架构 

基于主流基因组浏览器的 B/S（Browser/Server）架构，充分利用现代浏览器的普及度及优良的界面渲染，同时可依托服务器数据库，成为可浏览交互的数据平台。Haprose 分为前端、后端和数据库三部分，各部分相互独立，前后端以 RESTful API 进行交互，后端通过相应的库与数据库交互。 

由于基因组浏览器的内容呈现在前端，则有 SSR（Server-Side Rendering）、CSR（Client-Side Rendering）、SSG（Static Site Generation）等多种渲染方式。Haprose 因以呈现图形界面为主，且刷新频率较高，选用 CSR 能够实现高性能、实时、流畅的浏览体验，且渲染的矢量图形具有更高的清晰度，从而避免了使用 SSR 的传统基因组浏览器网页卡顿、对网络和服务器负载较大的缺陷。 

为减少数据传输量从而降低网络负载，并实现可视化数据和可视化形式的解耦从而提高开发稳定性，前端需要实现数据的解析和绘图逻辑。实际的泛基因组因为数据量大（压缩后1×10^6~10^7 B），无法通过网络传输和处理整体的数据，因此基于浏览器的泛基因组可视化工具，要么只能进行舍去细节的粗略可视化，要么只能选择一小部分区域进行可视化；而安装在本机通过读取硬盘的可视化软件也存在加载和渲染缓慢的问题。通过抽离出这些工具绘图的本质逻辑，以及受到 web 地图的启发，Haprose采取了“层级化”数据的理念，将泛基因组数据根据尺度分为不同级别，由大尺度到小尺度分别呈现不同精细程度的数据内容，尺度越小时约为精细，但可见区域也更小，使得每个尺度传输的总数据量相近且较小。这与用户的使用需求相适配，即从一个宏观尺度浏览该泛基因组的整体情况，在找到感兴趣的位点后逐步放大进行更深入的研究，通过软件设计中“按需加载”的理念，提高了性能，且刨除了意义不大的繁杂信息，为用户减轻视觉负担，增强了界面和交互友好性。 

由于原本的泛基因组数据格式（GFA，vg，xg，odgi等）不具有可拆分性，无法直接实现层级化、分而治之的数据传输和绘制，因此本研究研发了名为 HAP 的数据模型，用于赋予泛基因组浏览器的可视化、线性和图形模式转换、添加注释、搜索信息等能力。但 HAP 的设计因处理了图形泛基因组建立坐标系的难点，以及其考虑到泛基因组数据演化的趋势，和对注释的兼容性纳入等，使得其具有成为一种实用且不可替代的泛基因组数据格式的资质，在一些使用场景上有超越现有泛基因组格式的可能。 

由此，泛基因组浏览器以 HAP 为核心，在接受用户从浏览器发来的请求后，服务器端程序从数据库检索到指定的条目并组合成一个 RST（Region-Segment Tree，详见 Hap 设计部分），返还给前端，前端程序对该部分数据进行可视化，并借由一并传输到宏数据告知用户当前浏览区域的所在位置等信息。注释信息同理。 

将现有的图形泛基因组转化为 HAP 需要经过一系列的数据处理和整合，因而开发了服务器端的 CLI 程序 Hap。Hap 被设计为向公众开放的程序，提供对 HAP 模型的数据实体进行创建、编辑、添加注释等操作（类似于 vg 和 odgi），使得研究人员能够自行创建 HAP 格式的泛基因组，上传到服务器或在本地搭建 Haprose 进行可视化和浏览（如同 IGV），不仅能够推动 HAP 的传播和发展，也能让 Haprose 在更广的范围内得到使用。目前因处于开发早期，尚未有相关需求，只进行了由 GFA 格式的图形泛基因组创建 HAP 的功能实现。 

综上所述，本研究的图形泛基因组浏览器工具以表现层、工作层和数据层三层架构为基础，对数据的读写分离（Read/Write Splitting）到系统中不同的部分（Haprose 和 Hap）中，形成了四个部分之间进行交互的简单系统结构。 

## 系统各部分设计 

### 可视化难点与模型设计 

#### 泛基因组可视化效果及模型设计 

目前市面上已有一些泛基因组可视化工具，乃至“泛基因组浏览器”，但存在呈现的图像杂乱、可读性差，或信息量少、交互性差等问题，本工具的设计目的即在于解决上述痛点，为用户解读和研究泛基因组数据提供切实便利。对泛基因组数据可视化依据直观、美观的原则，从泛基因组的模式图出发，将人们脑海中对泛基因组的形象认知摹写在屏幕上，达到无需过多解释即可理解的效果。对泛基因组进行可视化的效果如图 4-1 所示。 

![](./internal/img/haprose-visual-model.png)图 4-1  Haprose 可视化泛基因组效果设计 

Fig. 4-1  Haprose pangenome visualization design 

以 4 个基因组构建而成的泛基因组的可视化效果设计。图中圆角矩形为图形泛基因组的结点，矩形的长度对应该片段序列长度，线段为图形泛基因组中连接结点的边。（A）所有结点根据在基因组上的位置从左到右排列，同一位置的节点垂直并列，代表其替代性关系。（B）在线性模式中，结点的横向位置与图形模式中一一对应，纵向则根据在每个基因组上出现与否进行展示。 

现有的一些可视化工具采取将图形泛基因组作为普通的关系图来绘制呈现的方式，舍去了基因组的特征，呈现的图像较为晦涩，也缺乏有价值的信息，使得习惯于线性基因组浏览器的用户们难以适应。因此，Haprose 对于泛基因组的可视化选择线性与图形、一维与二维相结合的方式（图 4-1），其结点从左到右的排布充分反映了在基因组上的位置，而垂直排列的多个节点（或结点与空线段）则反映了之间的替代性关系。其图形模式的呈现符合图形泛基因组的模式图构想，而线性模式符合传统的基因组呈现。但现有的图形泛基因组数据格式并不包含结点间的替代性关系（图中的垂直并列关系），且包含嵌套结构的图则更无法解读。为了能够让 Haprose 的前端绘图程序能够方便和正确的解析、绘制图形泛基因组数据，已有的图形泛基因组数据必须经过处理，转换成一种新的数据格式。 

我将图形泛基因组中的结点分为两类，一类是所有基因组共享的一致性（consensus）结点/序列，另一类是部分基因组中存在的可变（variable）结点/序列。从核酸序列产生、演化的角度进行思考，我认为所有可变序列都应在基因池中具有同等的地位，同时所有不变的核心序列也是在演变中的可变序列。因此在泛基因组上，根据有变异与否将基因组横向划分为一系列区间（region），其中并列关系的结点同属一个区间，而不变的结点自身属于一个区间，以容纳其未来可能的变化。图形泛基因组中所有的结点，对应到 HAP 中的一个片段（segment），每个片段相当于一条可能的序列（非必需），而变异类型中的缺失（deletion）对应到一个长度为 0 的空 segment 。这样，泛基因组成为了一条一维的 region 序列，每个 region 中包含数目大于或等于 1 的 segment 列表。这保证了 HAP 模型理论上的简洁性和完备性，也为向层级化扩展提供了基础。 

#### 变异的尺度、嵌套变异与层级化模型 

图形泛基因组中的结点是变异序列，严格来说，一个片段的序列应与基因组完全不匹配，从而视为一个变异，即序列两端不应有能够与其他序列重叠的碱基。但就生物学意义而言，等位的两个变异之间可能存在部分匹配的序列（如等位基因），这种情况下是否应提取出相同/相似序列作为不变序列，从而将一个变异拆分为多个，就是需要考量，即确定变异边界的问题。如果严格按照碱基序列的不同来定义变异结点，图将精细到大部分为SNP的单碱基尺度，但也失去了更大尺度上的语义。同时在更大尺度上展示出的结点数量将极其庞大，不仅给用户带来沉重的视觉负担，计算和内存资源也远远无法支持。 

在图格式的泛基因组数据处理中，一直存在嵌套变异解析的问题。嵌套变异指的是在一个可变结点上存在的更小的变异，因不属于父可变结点之外的结点，只能嵌套在父结点内部。图格式能够合理的表示这种嵌套情况，即原先的一条结点路径（path）产生分支变为局部的一个子图（subgraph）。这发挥了图格式存储泛基因组的优势，但也带来了子图嵌套的大幅使用，而这种复杂的图给下游的图形泛基因组数据处理和可视化程序带来了极大的困难。也正因如此，有开发者们专门制作了将图形泛基因组进行扁平化的工具，而构建图形泛基因组的软件自身也开始避免使用嵌套的形式。 

稍加思索便可以发现，上述两个问题其实是同一个问题，即粗略变异嵌套精细变异的问题。泛基因组的研究在蓬勃发展，相应的软件也在不断地产生和迭代，新工具构建出的图形泛基因组会比原先更加精细、准确，包含更多维度的信息。更新的图形泛基因组并不一定是从头构建的，而可能是通过对原先的图形泛基因组进行增加细节、删去错误等修饰，这种更具性价比的方式。因而不能期望处理的泛基因组是固定不变动的，而是要为嵌套变异的发现开辟空间，以包容的数据格式鼓励图形泛基因组向着更精细化的方向发展。 

为了解决该问题，本研究提出了层级化泛基因组的概念。所谓层级化，指的是以尺度为划分，创建层层嵌套，大尺度上更粗略的结点包含了小尺度上可见的、更精细的结点。对于变异边界的确定问题，在基因组/部分基因组区域的大尺度水平，变异序列的长度在几十到几千碱基（base pair，bp）不等，以有生物学意义如基因、基因组元件的序列范围来确定其边界；而在碱基水平，变异结点在几bp大小，作为上述大结点的嵌套子结点（图 4-2）。HAP 模型的关键点，就是将包含嵌套变异的子图结构作为单个 segment 来存储和呈现（图4-3），在更高的尺度通过隐藏内部结构来缩减数据量。因为该类型 segment 内部包含多条可能的路径，因此其自身不具有确定的序列，但仍具有长度属性，用来反映其包含的region序列，亦即子泛基因组的长度。在 HAP 模型中，这类 segment 称为封装（wrapper）segment，用于封装子图，即子region序列；子region中包含的segment也可以是wrapper segment。Wrapper segment和具有真实序列的segment遵循同样的数据模型，仅通过一项标识字段进行区分，类似于文件系统中目录与具体文件的关系。HAP 模型与 Haprose 可视化浏览中的缩放相对应，在较大尺度省略细节，提供清爽界面的同时降低数据负载，而在不断放大某感兴趣区域进行探索的过程中，呈现更深层更精细的图形泛基因组结构。这样利用嵌套解决复杂的嵌套问题，又解决了其他泛基因组可视化工具无法实现的尺度切换问题。 

![](./internal/img/node-display-pattern.svg)

图 4-2  不同尺度下变异结点的定义和展示方式 

Fig. 4-2  Definition and presentation of variation nodes at different scales 

相同内容的图形泛基因组数据在不同尺度下的表现形式。在较大尺度，以具有生物学意义的序列整体作为结点，等位的结点间可能包含相同序列；在较小尺度，仅根据序列的不同划分变异，即等位的变异间不存在相同或相似序列。 

 ![](./internal/img/haprose-zoom-effect.png)

图 4-3  缩放展示不同尺度泛基因组细节 

Fig. 4-3  Zoom to show pangenome details at different scales 

在不同尺度下浏览同一个泛基因组的效果。在较大尺度（级别3、4），包含嵌套变异的子图被封装在一个 segment 中，其长度对应子图中泛基因组的长度，视觉效果以及大部分数据属性与其他 segment 无异。 

#### 跨尺度可视化效果一致性 

前文中提到，层级化泛基因组模型的设计灵感来源于web地图，因此其缩放逻辑和交互效果的设计也以web地图为原型。在web地图中，地球的面积是固定且已知的，将其平面化并作为第一级的瓦片地图，接下来每一级将比例尺缩小一半，如 4×4  的瓦片被划分为4个 2×2  的瓦片，放大一倍后以与之前相同的视觉大小展现给用户，以此类推，直到一个限定的最小层级。在这个过程中，因为只有比例尺和可见面积的变化，地球上所有物体的相对和绝对位置不变，所以可以通过固定的（经纬度）坐标获取到当前浏览区域和地点的位置信息。Haprose可以视作一维化的地图，其世界范围为多序列比对坐标系的边界。然而与真实地图不同的点在于，我将代表结点的圆角矩形的长度设定为序列长度的精确映射，且要在各层级下保证这种精确性；同时出于绘图美观性的考量，结点间连接的边需要占据一定的横向长度，且在各层级下的视觉长度相近。这就意味着，抛开结点的缩略化不谈，在进行缩放时结点长度和边长度的变化不是同比例的，这将会影响不同层级下视觉上的总泛基因组长度。例如在级别3下屏幕显示长度为30 px的结点，左右有10 px的边，共50 px；放大一倍后结点长度为60 px，左右边长仍为10 px，共80 px，而不是50x2=100px。而可视化呈现的视觉长度和区间理应是泛基因组坐标系的映射，这种不同尺度下的不一致性将会导致无法简单地定位泛基因组坐标。这就好比在缩放地图时，表征的地球大小随之变化了，视觉呈现和真实地理不一致了，则视觉定位和实际的地理定位无法简单对应了。对于这个问题，只能在结点长度的精确反映、跨尺度边长不变性、跨尺度视觉总长度不变三者中舍去其一才能解决。如若放弃结点长度的精确反映，则可根据该层级下固定的视觉总长减去固定的边长，再除以各结点长度所占比例，得到相对的视觉长度；如若放弃跨尺度边长不变性，则边长随缩放增大或减小，有可能出现短到无法辨识/长到占据整个界面的情况；如若放弃跨尺度视觉总长度，则为上文所述无法进行泛基因组坐标的简单对应，而在泛基因组浏览器这种需要频繁切换观察区域的使用场景中，显著增加了处理难度。最终，为了满足本可视化工具直观、美观的第一要义，我还是选择了第三种方案，但为了用户一如线性基因组浏览器的交互体验，需要在前端的代码处理上增加不少复杂度。 

#### 层级化可视化效果与设定 

为提供一个合理、良好的交互体验，Haprose 的缩放交互选取与web地图相似的设定，即每一级别的比例尺是上一级别的一半（比例尺定义为：泛基因组长度:显示的泛基因组图像长度，单位bp/px）。Web地图的缩放级数是根据地球的表面积大小和地图所能呈现的精度决定的，因此不同的web地图有着差不多的缩放级数。对于泛基因组而言，每个图形泛基因组的总长度都不同，根据构建的物种、样本量可能会具有几个数量级的差别。如要保证对于不同长度（大小）的图像泛基因组，都能在最大尺度和最小尺度有相近的浏览体验，则不能使用相同的缩放级数和比例尺，而是根据具体的泛基因组大小计算得到相应数值。由于计算方式已经确定，所以最小一级的比例尺只取决于最大一级的比例尺和缩放级数。如若在不同的泛基因组间保持最大一级呈现长度的相同，如 100% 屏幕宽度，则在最小一级的比例尺上可能会有几到十几倍的差异，而这种差异会使得同样长度的序列，在另一个泛基因组中有着不同长度的显示。比如在 a 泛基因组中最小一级长度为 1 bp 的一个SNP位点，显示长度为15 px（像素宽度，pixel），而在 b 泛基因组中显示长度则变为 100 px，这种不一致性将导致给用户带来困惑和错误解读。反过来，固定最小级别的比例尺，将会导致在最大级别的不一致性，如同样100%显示的泛基因组，a恰好占据整个屏幕的宽度，而b可能大于屏幕宽度。此处就是涉及选择一种保留一致性而舍弃另一种。考虑到在精细尺度上的浏览是更为重要也更频繁的使用场景，且对比例尺变动更为敏感，所以选择保留最小尺度的视觉一致性，固定不同泛基因组的最小比例尺为同一数值，更高级别的比例尺则随级数而计算得出。 

Haprose 的缩放以2的倍数为变化幅度，而图形泛基因组原本具有的嵌套层数往往比缩放级数少的多，特别是在目前扁平化图形泛基因组的趋势下。这就导致了许多缩放级别呈现的是同一组内容，使得缩放的行为失去其意义；并且会导致大片段在不断放大的过程中变得非常长，使得用户如何移动也只能观察到这一个片段。比如，拟南芥基因组约为100 Mbp，假设由10个拟南芥基因组构建成的泛基因组将在多序列比对坐标系中增加 20% 的长度，总长度120 Mbp，设定最小比例尺为0.04 bp/px，则0.04×222=167,772.16  bp/px，在1000 px宽度下即可包含约167 Mbp序列，即最少23个缩放级别；而图形泛基因组中包含的嵌套层数一般小于5。为避免无意义的缩放，发挥HAP模型的优势，需要对原有的图形泛基因组进行人为的wrapping，形成具有合适层数的HAP。而人为的wrapping是基于当前层级的比例尺和segment长度，规则为：一个region中包含小于规定可见长度的segment时，即与左右临近的region相合并，形成一个包含了内部region序列的wrapper segment，该wrapper segment长度为所包含全部region的总和。包含该wrapper segment的region又会在更高层级被合并。在最大一级，所有region被wrap进一个segment，即根segment，其所在的即为根region。对于每一个HAP，都具有根region和根segment，其中包含的就是该泛基因组的全部内容。这样即形成一个深度嵌套的Region-Segment Tree，称为RST。而用户使用Haprose时，也像使用文件系统一样，从根目录开始逐步找到想要的文件。 

#### 泛基因组索引设计 

作为图形泛基因组浏览器，除可视化浏览之外，方便、稳定的检索系统是另一核心要求。图形泛基因组由于其链表本质，对其构建合适索引也是一个难点。而坐标系，就是索引的一种构建形式。因此，具有坐标系的HAP模型同样能够建立索引。由于HAP是多级的树状结构，其具有意义的结点分散在不同层级中以segment形式存在，所以除横向的region序列和多序列比对坐标系之外，还需要在缩放层级这一维度构建索引。其索引顺序为：泛基因组→缩放级别→泛基因组坐标系区间。例如，用户开始浏览一个构建好的玉米泛基因组，首先呈现的是最大一级，即包含整个泛基因组的根segment， 同时会显示所在的泛基因组坐标区间（此时为最大区间）；由于坐标系在各缩放尺度间保持一致，用户可以在一个指定的区间进行缩放来观察该区间情况，这个过程对于Haprose而言，就是记录缩放前的区间和尺度，再根据缩放后的尺度更新可见的区间范围，获得相应的HAP数据；而在同一尺度左右移动进行浏览时，则通过计算移动的程度更新要显示的坐标区间，在同一尺度下找到对应区间的HAP数据。但是，仅以缩放级别和坐标系区间为索引，并不能得到唯一确定的region序列。这是因为RST的树形结构中，同属一个region的几个segment可能都具有内部的嵌套结构，由于这几个segment为纵向并列关系，其坐标区间也相同，因而其内部的子region序列所处的区间也相同；在放大到子region一级时，以给定的区间就会得到多种可能的region序列，占据同一个位置。以地图来类比的话就是，在二维平面地图上，以经纬度坐标即可确定一个地点，而现代更为精细的地图还会记录楼房内部的信息；对于具有多层的建筑，单单给出经纬度并不能确定某个地点，还需要给定楼层（如2F，2nd floor），因为垂直并列的多个楼层间共享了同一片区域坐标。因此，在缩放级别和坐标区间之后，HAP索引系统的第三个参数就是指定区间的父segment。对于每个多segment的region，即变异region，都指定一个segment为默认的父segment，该默认值的指定以判断在同级的segments中更可能有研究意义的为原则。这就等同于web地图中，对于楼房来说，如果没选择浏览的楼层，则默认给出一楼的情况。对于有多个变异region的区间，仅允许指定其中一个region的父segment，这样的设定契合用户对某一区域深入探索的使用场景，也提高了查询性能，最重要的是使得索引操作简洁、规范、易于管理。 

#### 染色体与子图拆分 

与基因组相同，泛基因组也不是连续的，而是可以划分成不相关的多个域。以图的角度来看，就是可以拆分为多个不连通的子图。这种不连通可能有两种情况：1. 因为基因组中固有的无关性，如不同的染色体；2. 因为数据上的缺陷，如测序和组装出现的间隙（gap）。Hap模型将每个图形泛基因组分为一至多个子图进行存储和呈现，每个子图都需满足全连通性，即子图不可再分。在Haprose中进行浏览时，是根据泛基因组→子图的递进选择，在子图层面进行可视化的；即每个子图都是一张完整无间断的图，多个子图不同时在一个界面进行展示。虽然对于子图的数目和大小没有限制，但Hap及Haprose以具有生物学意义即第一种原因的不连通为原则，来进行子图的划分。也就是对于构建良好、完整的图形泛基因组，其子图数目等于染色体数目（不考虑染色体间的互作）。而第二种原因的不连通，意味着一条染色体级别的泛基因组被打断为多个片段。因片段间的gap而将一个图形泛基因组拆分成多个图，即将一个结点切断为两个端点，是不符合图形泛基因组的含义的，因而对于能够判断片段前后关系、间隔长度的情形，Hap将对两端的结点进行合并，以一个中间部分序列未知的结点作为替代。也就是说，Haprose能够展示任意大小的泛基因组，但对于完整的基因组，将尽可能以染色体为完整划分进行展示。 

#### 与各来源基因组的对应 

如上文所述，Haprose能够同时以图形和线性模式展示泛基因组的情况。而以线性模式展示就要求数据中具备组成泛基因组的各来源基因组的信息。在图形泛基因组中，这种信息是以串联结点的路径存储的。每条基因组应具有一条对应的路径，记录其经过的结点及结点的顺序。也就是说，对一个不可分割的子图而言，具有几条基因组，就应该有几条路径。多个基因组共有的序列，对应多条路径共有的结点。以路径为主体储存节点的路径信息是图形泛基因组软件的普遍方式，但由于储存的其实是路径-结点阵列，所以也可以以结点为主体，将通过该结点的路径名称保存在结点中。Hap使用的即是这种方式，并默认路径的命名中包含了基因组名称或标识，从而使得每个结点都有其基因组来源的记录。这样，在Haprose的展示中，即可实现图形和线性模式任意切换的效果。 

#### 图形泛基因组注释体系 

如何将基因组注释纳入到泛基因组模型中，建立泛基因组注释，是制约泛基因组广泛使用，特别是以泛基因组参考替代线性参考基因组的一大难题，至今仍未有解决方案。本研究借助HAP模型的坐标系和索引系统，对此给出了一套可行的理论。 

基因组注释无论其类别，本质是可以定位到基因组上，亦即一个基因组注释一定与一段序列相关联。图形泛基因组无法添加和展示注释的根本原因，还是没有合适坐标系的问题。而HAP模型中，每个包含序列的segment都有给定的坐标，因此可以对应到一个或多个segment的基因组注释也同样可以映射（map）到HAP的坐标系。由于图形泛基因组中的路径（path）等同于线性基因组，所以基因组注释其实是位于一条路径的一段区域上，而路径是由相连的结点组成，即基因组注释总是对应到几个相连的结点上。因此，给出基因组注释对应序列所在的结点，以及序列片段在结点上的坐标区间（结点内部的线性坐标系），就得到了图形泛基因组体系下的注释。在多数情形下，基因组注释只在一个segment内部，其定位及标记更为简单。而由于HAP中的segment具有层级，HAP模型下的注释也同样具有层级，即在不同尺度浏览到不同长度的注释信息。由于HAP模型支持图形和线性两种格式，且在同一坐标系下，因此可以以实现线性基因组注释和图形泛基因组注释呈现的切换，并且可以将任何现有的基因组注释，转化为指定的图形泛基因组上的泛基因组注释。Hap赋予的这种能力使得图形泛基因组既具有泛基因组的优点和图格式的特质，又能兼容线性基因组注释，将已有的注释数据纳入图形泛基因组中，从而推动泛基因组的发展和利用。 

#### HAP模型归纳 

前几节分别就问题引入了HAP模型的各个部分，现就HAP模型整体作一归纳概括，并给出规范定义。 

HAP名为层级化泛基因组，对应一个泛基因组/图形泛基因组（pangenome）。一个HAP中包含一至多个subgraph，其subgraph为可视化的基本单元；如若是一个完整不可分割的泛基因组，则其自身成为其subgraph。每个subgraph为完整的连通图，subgraph中包含region序列。Subgraph依据其泛基因组大小，具有对应的缩放级数（max_level）、总长度（total_length）、和总变异数目（total_variants）的统计。一个不可分割的subgraph，包括其内部嵌套的任意子图/提取出的任意部分都是一个region序列。Region可分为consensus和variation两类，前者包含一个segment，后者包含>1个segment，其中的segments并无规定顺序。所有segment都被包含在一个region中，即每个segment必然具有父region。Region和segment的形态见图4-4。一些segment内部包含嵌套结构，即子图，如上所述，子图 = region序列，即segment可以包含0至多个region，其中的regions以顺序排列，这类segment称为wrapper segment。除最高一级的region（root region）外，每个region都被包含在一个segment中，即除唯一的root region之外，所有region都具有父segment。这样形成了一个region与segment互为父子的树形结构，且在树的任意一条路径中，region和segment必然是交替出现。因没有类似的数据结构，我将其命名为混合树（mixed tree），在当前应用场景下为Region-Segment Tree，简称RST。也就是说，一个HAP以一个RST形式存在，在提及数据内容时可以将两者等同。两者的区别在于，HAP是由根region开始的一个完整的RST，而RST中任何非叶子结点的子树也都是一个RST，即自相似的分形结构。 

除了主要的泛基因组模型外，HAP中纳入了注释作为模型的附属部分。注释与segment的身份相似，每个注释会与尺度相关联以便显示，每个注释对应一至多个segment，因其所在的基因组路径可能跨越了多个segment。一个segment上也可以存在多个注释。HAP中注释与segment的关系，与线性基因组中基因组注释与基因序列的关系相同。 

 ![](./internal/img/hap-model.png)

图 4-4  HAP 模型的 Region 和 Segment 概念 

Fig. 4-4  Region and Segment concepts for HAP model 

HAP 的泛基因组由一系列顺序排列的 regions 组成，图形泛基因组中的节点对应 HAP 中的segment，region 根据其类型可包含一个至多个 segment，其中的 segments 并无规定顺序。 

![](./internal/img/hap-ER-diagram.png)

图 4-5  HAP 模型实体关系图 

Fig. 4-5  HAP model Entity Relationship diagram 

一个泛基因组为一个 HAP，一个 HAP 具有一至多个 subgraph，一个 subgraph 具有许多regions，每个 region 具有一至多个 segment。每个注释与一至多个 segment 对应，而一个 segment 上也会有多个注释，每个注释必定属于某个泛基因组。 

#### 结点着色方案 

颜色作为可视化的一环，不仅起到美观的效果，还应作为一个信道，提供以此形式易理解的信息。Haprose中以segment为单元进行着色，则着色的异同应该成为判别不同segment差异与共性的一个依据。我考虑了以下几种方案： 

每个结点一个颜色，顺序/随机使用色板中的颜色，顺序使用则在用尽时周而复始。优点是能够较好的区分开相邻的结点，缺点是颜色缺乏含义，且容易让人眼花缭乱。 

一条路径即一个基因组中的结点使用同一个颜色，在多条路径中出现的结点，则以这些路径颜色的混合作为着色。优点是以颜色的叠加体现了基因组序列的重合，缺点有：a. 提供的泛基因组不一定有路径信息；b. 涉及到的颜色很多，实时计算量大，且叠加后的颜色不一定具有区分度。 

相同来源的结点使用同一个颜色，如结点1和2都来源于基因组a、b、c，而结点3只来源于基因组a、b，则结点1和2使用同一个颜色，而3使用另外的颜色。假设泛基因组由n条基因组构建而成，则可能的颜色组合就有2^n种。优点是以颜色体现了基因组来源，缺点是需要较多的颜色进行区分。 

在仔细考量及实验后，我采用了方案三作为结点着色的方案。虽然理论上需要2^n种颜色，但实际的基因组来源组合并不会覆盖每种可能的情况，并且在单屏显示范围内出现超出色板的色彩需求的可能性较小，因此只需按顺序为新基因组组合的结点分配颜色，色板用尽后周而复始即可。 

### Haprose界面及交互逻辑设计 

为打造一个用户友好、美观而便利的浏览器应用，Haprose 的界面设计以清爽、直观为目标，不仅尽可能减少文字说明，也尽可能减少冗余的交互控件，且充分考虑各用户群体的软硬件限制和设备偏好。Haprose 借鉴了游戏这一将交互作为重点的产品的界面和交互理念，将供浏览的泛基因组作为主体，尽可能占据可显示的空间，而在四周不影响浏览也不容易误触的空白角落处放置控件或信息窗口。 

#### 交互方式多样性 

如前所述，Haprose 对于泛基因组浏览时的内容切换支持缩放、左右移动、切换图形/线性模式、以缩略图选取点进行跳转等。对于这些操作，Haprose提供了键盘按键、鼠标点击、鼠标滚轮滚动、可触摸屏幕滑动等多种设备的交互方式，使用户能够符合直觉地、便利地进行浏览，同时也可以减少只用于鼠标点击的眼花缭乱的控件，使界面更加简洁。但对于有这类使用习惯的用户，Haprose也提供了所有以鼠标操作的控件，只需从隐藏面板中调出即可。 

#### 响应式设计 

由于Haprose的界面置于Chrome等浏览器中，而浏览器是跨设备、跨平台的基础设施，因而需要对不同机型、不同浏览器及不同版本等进行适配。即便是在同一个设备上使用时，用户也可能调整浏览器窗口横纵大小，因此在设定界面的一些基本参数时，就要考虑最低限度的要求是怎样的，且同时给不同配置的用户尽可能优秀且一致的体验。这即是在讨论Haprose的响应式设计。在浏览器界面像素宽度小于768 px时，显示的内容位置不再随窗口缩小而调整，即为界面主体的最小宽度；同理，设定的最小高度为500 px。在浏览器窗口大小变动时，显示的可视化内容始终保持居中于窗口，同时控件始终保持在四周（在长和宽不小于上述最低限度的情况下）。为了给不同设备尺寸的用户一致的可视化效果体验，Haprose的响应式不同于一般web界面，只对一些可调整大小的元素或可缩略的控件施加响应，而是会随浏览器宽度实时计算决定序列可视长度的比例尺。这一点与同为前端渲染、交互良好的JBrowse不同。响应式的渲染增加了实现难度，也给浏览器带来了渲染负担，不过其服务的目标场景是静态下的浏览器宽度差异，而不是用户刻意反复调整浏览器宽度，所以一般而言不会造成性能损耗。 

#### 结点显示长度计算 

基因组可视化中的一个关键点就是将序列长度在屏幕上以一定方式呈现给用户。如果以矩形代表基因组/转录组/蛋白组序列，那么最直观的方式就是以矩形的长度成比例的反映其序列长度。在Haprose中，即是以这种方式反映结点的序列长度的。但要选取一个合适的比例去做这种映射，并且计算各缩放尺度的比例尺，也可称作分辨率。

#### Haprose前后端传输数据设计 

在系统设计部分就提到，HAP模型的诞生出发点之一，就是为了将数据分成小块来进行必须的展示，降低经由网络的数据传输量，和渲染程序的计算负担。由于分割数据的思想也部分来源于web地图瓦片的切分，所以设计初期也采用了预先对整个泛基因组进行等分，而后根据位置传输相应切片数据的方式。然而，如果以固定长度来切割泛基因组，将会有许多region和segment被拦腰斩断，一部分属于前面的切片，另一部分属于后面的切片。这样缺失头尾的region和segment给前端绘图程序带来了很多难点，比如判断是否为完整的元素，绘制部分片段，与后一部分数据的拼接等等。而如果以保证片段完整为原则，那么分割出的片段长度差别可能很大，因为基因组上变异的密度和变异长度并不是均匀分布的。并且以这样的规则，一个泛基因组可以有多种分割方式，就像在测序时将长片段打断为几套不同的contigs一样。为了避免这种分割和处理操作上的未知性，我最终放弃了对泛基因组数据进行预先分割，而是采取通过Haprose的后端程序实时查找并组合出所需区间的最小region序列的方式，达到获取需要浏览的小片段数据的效果。 

### HAP数据库关系模型 

以UML图展示HAP数据库的主体实体模型和实体关系设计如图4-6。 

![](./internal/img/hap-UML-diagram.svg)

图 4-6  HAP 数据库实体模型和关系模型 

Fig. 4-6  HAP database entity model and relational model 

图中列出了各实体的主要字段和实体间的关系。 